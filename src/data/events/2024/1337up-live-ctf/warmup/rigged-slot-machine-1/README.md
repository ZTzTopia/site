---
title: "Rigged Slot Machine 1"
category: 
  - Miscellaneous
  - "Binary Exploitation"
tags: 
completedDuringEvent: true
submitted: true
flag: INTIGRITI{ju57_l1k3_7h47_y0u_4r3_4_m1ll10n41r3!}
draft: true
---
## Scenario

> The casino thinks they've rigged their slots so well, they can give every player $100 free play! Of course, there's always some small print: you can't cash out unless you hit the jackpot and each player only gets 3 minutes play time
>
> `nc riggedslot1.ctf.intigriti.io 1332`

By CryptoCat

## Solution

The challenge is a slot machine game where the player can bet up to `$100` per spin. The player starts with `$100` and can only cash out if they win more than `$133742` within `3` minutes. The slot machine is rigged, and the player can predict the outcome of the slot machine by predicting the random number generated by the `rand` function.

```c
int __fastcall __noreturn main(int argc, const char **argv, const char **envp)
{
  unsigned int v3; // eax
  int v4; // [rsp+8h] [rbp-18h] BYREF
  int v5; // [rsp+Ch] [rbp-14h] BYREF
  __gid_t rgid; // [rsp+10h] [rbp-10h]
  int v7; // [rsp+14h] [rbp-Ch]
  unsigned __int64 v8; // [rsp+18h] [rbp-8h]

  v8 = __readfsqword(0x28u);
  setvbuf(_bss_start, 0LL, 2, 0LL);
  rgid = getegid();
  setresgid(rgid, rgid, rgid);
  v3 = time(0LL);
  srand(v3);
  setup_alarm(0xB4u);
  v4 = 100;
  puts("Welcome to the Rigged Slot Machine!");
  puts("You start with $100. Can you beat the odds?");
  while ( 1 )
  {
    while ( 1 )
    {
      v5 = 0;
      printf("\nEnter your bet amount (up to $%d per spin): ", 100LL);
      v7 = __isoc99_scanf("%d", &v5);
      if ( v7 == 1 )
        break;
      puts("Invalid input! Please enter a numeric value.");
      clear_input();
    }
    if ( v5 > 0 && v5 <= 100 )
    {
      if ( v5 <= v4 )
      {
        play(v5, (unsigned int *)&v4);
        if ( v4 > 133742 )
          payout(&v4);
      }
      else
      {
        printf("You cannot bet more than your current balance of $%d!\n", (unsigned int)v4);
      }
    }
    else
    {
      printf("Invalid bet amount! Please bet an amount between $1 and $%d.\n", 100LL);
    }
  }
}
```

The slot machine is seeded with the current time.

```c
v3 = time(0LL);
srand(v3);
```

The `play` function is called when the player spins the slot machine. The function calculates the multiplier based on a random number generated by the `rand` function. The multiplier is then used to calculate the player's winnings or losses.

```c
unsigned __int64 __fastcall play(int a1, unsigned int *a2)
{
  int v3; // [rsp+1Ch] [rbp-14h]
  int v4; // [rsp+20h] [rbp-10h]
  int v5; // [rsp+24h] [rbp-Ch]
  unsigned __int64 v6; // [rsp+28h] [rbp-8h]

  v6 = __readfsqword(0x28u);
  v4 = rand() % 100;
  if ( v4 )
  {
    if ( v4 > 9 )
    {
      if ( v4 > 14 )
      {
        if ( v4 > 19 )
          v3 = v4 <= 29;
        else
          v3 = 2;
      }
      else
      {
        v3 = 3;
      }
    }
    else
    {
      v3 = 5;
    }
  }
  else
  {
    v3 = 100;
  }
  v5 = v3 * a1 - a1;
  if ( v5 <= 0 )
  {
    if ( v5 >= 0 )
      puts("No win, no loss this time.");
    else
      printf("You lost $%d.\n", (unsigned int)(a1 - v3 * a1));
  }
  else
  {
    printf("You won $%d!\n", (unsigned int)v5);
  }
  *a2 += v5;
  printf("Current Balance: $%d\n", *a2);
  if ( (int)*a2 <= 0 )
  {
    puts("You're out of money! Game over!");
    exit(0);
  }
  return v6 - __readfsqword(0x28u);
}
```

We can predict the outcome of the slot machine by predicting the random number generated by the `rand` function. The `rand` function is seeded with the current time, which means we can predict the random number generated by the `rand` function if we know the time the slot machine was started. We can then calculate the multiplier and the player's winnings or losses.

```c
if ( v4 )
{
  if ( v4 > 9 )
  {
    if ( v4 > 14 )
    {
      if ( v4 > 19 )
        v3 = v4 <= 29;
      else
        v3 = 2;
    }
    else
    {
      v3 = 3;
    }
  }
  else
  {
    v3 = 5;
  }
}
else
{
  v3 = 100;
}
```

The following script connects to the slot machine and predicts the outcome of the slot machine by predicting the random number by seeding the `rand` function with the current time. Also there is a time player can play the game, so we can't just waiting the slot machine to say "Enter your bet amount (up to $100 per spin): " and then send the bet amount. We just need to send the bet amount after the previous bet amount is sent.

```py
from pwn import *
import ctypes
import time

libc = ctypes.CDLL("libc.so.6")

context.log_level = 'DEBUG'

while True:
    r = remote('riggedslot1.ctf.intigriti.io', 1332)

    libc.srand(libc.time(0))
    balance = 100

    # r.recvuntil(b'Enter your bet amount (up to $100 per spin): ')

    for _ in range(1152):
        rand = libc.rand()
        rand = rand % 100
        multiplier = 0

        if rand == 0:
            multiplier = 100
        elif rand < 10:
            multiplier = 5
        elif rand < 0xf:
            multiplier = 3
        elif rand < 0x14:
            multiplier = 2
        elif rand < 0x1e:
            multiplier = 1
        else:
            multiplier = 0

        bet = balance
        if multiplier > 0:
            if balance > 100:
                bet = 100
        else:
            bet = 1

        balance += bet * multiplier - bet
        r.sendline(str(bet).encode())

    if b'INTIGRITI{' in r.recvall():
        r.interactive()
        break

    time.sleep(0.1)
    r.close()
```