---
import Dropdown from "./Dropdown.astro";

interface Props {
  uniqueId: string;
}

const { uniqueId }: Props = Astro.props;
---

<Dropdown dropdownId={`switchTheme-${uniqueId}`} icon="lucide:moon" position="right">
  <div class="flex flex-col gap-2">
    <button
      id="lightTheme"
      class="block px-4 py-2 text-left hover:text-tx-accent-hover hover:bg-flexoki-base-300 dark:hover:bg-flexoki-base-850"
    >
      Light Mode
    </button>
    <button
      id="darkTheme"
      class="block px-4 py-2 text-left hover:text-tx-accent-hover hover:bg-flexoki-base-300 dark:hover:bg-flexoki-base-850"
    >
      Dark Mode
    </button>
    <button
      id="systemTheme"
      class="block px-4 py-2 text-left hover:text-tx-accent-hover hover:bg-flexoki-base-300 dark:hover:bg-flexoki-base-850"
    >
      System Default
    </button>
  </div>
</Dropdown>

<script is:inline>
  const applyTheme = (theme) => {
    if (theme === "dark") {
      document.documentElement.classList.add("dark");
    } else if (theme === "light") {
      document.documentElement.classList.remove("dark");
    }
  };

  const applySystemTheme = () => {
    const systemPrefersDark = window.matchMedia(
      "(prefers-color-scheme: dark)"
    ).matches;
    if (systemPrefersDark) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  };

  const initializeTheme = () => {
    const savedTheme = localStorage.getItem("theme");
    if (!savedTheme || savedTheme === "system") {
      applySystemTheme();
    } else {
      applyTheme(savedTheme);
    }
  };

  const initializeListenet = () => {
    const lightThemes = document.querySelectorAll("#lightTheme");
    const darkThemes = document.querySelectorAll("#darkTheme");
    const systemThemes = document.querySelectorAll("#systemTheme");

    lightThemes.forEach((lightTheme) => {
      lightTheme.addEventListener("click", () => {
        localStorage.setItem("theme", "light");
        applyTheme("light");
      });
    });

    darkThemes.forEach((darkTheme) => {
      darkTheme.addEventListener("click", () => {
        localStorage.setItem("theme", "dark");
        applyTheme("dark");
      });
    });

    systemThemes.forEach((systemTheme) => {
      systemTheme.addEventListener("click", () => {
        localStorage.setItem("theme", "system");
        applySystemTheme();
      });
    });
  };
  
  document.addEventListener("DOMContentLoaded", () => {
    initializeTheme();
    initializeListenet();
  });

  document.addEventListener("astro:after-swap", () => {
    initializeTheme();
    initializeListenet();
  });
</script>
